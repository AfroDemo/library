import{q as V,r as o,m as g,j as e,$ as z}from"./app-DCuZLIiR.js";import{A as G,a as J,T as A}from"./app-layout-CxSrBOU3.js";import{D as K}from"./download-BkUYoEL1.js";import{S as Q}from"./search-BSJJuXeU.js";import{B as _}from"./chevron-right-MvP6eIpt.js";import{C as W}from"./calendar-B2KfnIy5.js";import{C as E}from"./clock-rXkSNBR3.js";import{D as X}from"./dollar-sign-C4xAu1P5.js";import{C as U}from"./circle-check-big-Opi59qMb.js";import"./app-logo-icon-l4AutvGA.js";import"./index-DWDx7uJa.js";import"./index-Bq50F9d8.js";import"./createLucideIcon-B80Gj0Dh.js";const Y=[{title:"Dashboard",href:"/dashboard"},{title:"Transactions",href:"/librarian/transactions"}];function me(){const{transactions:l={data:[],current_page:1,last_page:1,total:0,per_page:20},errors:b,success:j}=V().props,[v,B]=o.useState(l.data||[]),[f,S]=o.useState(l.data||[]),[x,C]=o.useState(l.current_page||1),[N,R]=o.useState(l.last_page||1),[F,m]=o.useState(!l.data.length),[d,D]=o.useState(""),[i,k]=o.useState("all"),[u,T]=o.useState("all"),[O,w]=o.useState([]);o.useEffect(()=>{l.data.length?(B(l.data||[]),S(l.data||[]),C(l.current_page||1),R(l.last_page||1)):(m(!0),g.get(`/transactions?page=${x}`,{status:i==="all"?void 0:i},{preserveState:!0,onSuccess:()=>{m(!1)},onError:()=>{c("error","Failed to load transactions"),m(!1)}})),j&&c("success",j),b&&Object.values(b).length>0&&Object.values(b).forEach(s=>c("error",s))},[l,j,b]);const c=(s,t)=>{const a=Date.now().toString();w(n=>[...n,{type:s,message:t,id:a}]),setTimeout(()=>{w(n=>n.filter(p=>p.id!==a))},5e3)},P=s=>{w(t=>t.filter(a=>a.id!==s))};o.useEffect(()=>{q()},[v,d,i,u]);const q=()=>{let s=Array.isArray(v)?[...v]:[];if(d&&(s=s.filter(t=>(t.student_name||"").toLowerCase().includes(d.toLowerCase())||(t.book_title||"").toLowerCase().includes(d.toLowerCase())||(t.member_id||"").toLowerCase().includes(d.toLowerCase())||(t.book_isbn||"").toLowerCase().includes(d.toLowerCase()))),i!=="all"&&(i==="active"?s=s.filter(t=>!t.returned_at):i==="returned"?s=s.filter(t=>t.returned_at):i==="overdue"&&(s=s.filter(t=>!t.returned_at&&new Date(t.due_date)<new Date))),u!=="all"){const t=new Date,a=new Date;u==="today"?(a.setHours(0,0,0,0),s=s.filter(n=>new Date(n.borrowed_at)>=a)):u==="week"?(a.setDate(t.getDate()-7),s=s.filter(n=>new Date(n.borrowed_at)>=a)):u==="month"&&(a.setMonth(t.getMonth()-1),s=s.filter(n=>new Date(n.borrowed_at)>=a))}S(s)},$=s=>{m(!0),g.get("/transactions",{page:s,status:i==="all"?void 0:i},{preserveState:!0,onSuccess:()=>{C(s),m(!1)},onError:()=>{c("error","Failed to load page"),m(!1)}})},h=s=>new Date(s).toLocaleDateString(),y=s=>!s.returned_at&&new Date(s.due_date)<new Date,I=s=>s.returned_at?e.jsxs("div",{className:"flex items-center text-green-600",children:[e.jsx(U,{className:"mr-1 h-4 w-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Returned"})]}):y(s)?e.jsxs("div",{className:"flex items-center text-red-600",children:[e.jsx(A,{className:"mr-1 h-4 w-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Overdue"})]}):e.jsxs("div",{className:"flex items-center text-blue-600",children:[e.jsx(E,{className:"mr-1 h-4 w-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Active"})]}),L=(s,t)=>{if(!s){c("error","No pending extension request found");return}g.post(`/transactions/extension/${s}/process`,{status:t},{onSuccess:()=>{c("success",`Extension request ${t}`),g.reload({only:["transactions"]})},onError:a=>{Object.values(a).forEach(n=>c("error",n))}})},H=()=>{const t=[["Transaction ID","Student ID","Student Name","Book ISBN","Book Title","Borrowed Date","Due Date","Returned Date","Status","Fine","Extension Status"],...f.map(r=>[r.id.toString(),r.member_id||"N/A",r.student_name||"Unknown User",r.book_isbn||"N/A",r.book_title||"Unknown Book",h(r.borrowed_at),h(r.due_date),r.returned_at?h(r.returned_at):"Not returned",r.returned_at?"Returned":y(r)?"Overdue":"Active",r.fine_amount?`$${r.fine_amount.toFixed(2)} ${r.fine_paid?"(Paid)":"(Unpaid)"}`:"$0.00",r.extension_status?`${r.extension_status.charAt(0).toUpperCase()+r.extension_status.slice(1)} ${r.requested_days?`(${r.requested_days} days)`:""}`:"None"])].map(r=>r.map(M=>`"${M}"`).join(",")).join(`
`),a=new Blob([t],{type:"text/csv"}),n=window.URL.createObjectURL(a),p=document.createElement("a");p.href=n,p.download=`transactions_${new Date().toISOString().split("T")[0]}.csv`,p.click(),window.URL.revokeObjectURL(n)};return e.jsxs(G,{breadcrumbs:Y,children:[e.jsx(z,{title:"Transactions"}),e.jsxs("div",{className:"flex h-full flex-1 flex-col gap-4 overflow-x-auto rounded-xl p-4",children:[e.jsx("div",{className:"rounded-lg border border-gray-200 bg-white p-6 shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Transaction History"}),e.jsx("p",{className:"text-gray-600",children:"View and manage all library transactions"})]}),e.jsxs("button",{onClick:H,className:"flex items-center space-x-2 rounded-lg bg-blue-600 px-4 py-2 text-white transition-colors hover:bg-blue-700",children:[e.jsx(K,{className:"h-4 w-4"}),e.jsx("span",{children:"Export CSV"})]})]})}),e.jsx("div",{className:"rounded-lg border border-gray-200 bg-white p-6 shadow-sm",children:e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700",children:"Search"}),e.jsxs("div",{className:"relative",children:[e.jsx(Q,{className:"absolute top-1/2 left-3 h-4 w-4 -translate-y-1/2 transform text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search by student, book, or ID...",value:d,onChange:s=>D(s.target.value),className:"w-full rounded-lg border border-gray-300 py-2 pr-4 pl-10 focus:border-blue-500 focus:ring-2 focus:ring-blue-500"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700",children:"Status"}),e.jsxs("select",{value:i,onChange:s=>k(s.target.value),className:"w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"all",children:"All Status"}),e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"returned",children:"Returned"}),e.jsx("option",{value:"overdue",children:"Overdue"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700",children:"Date Range"}),e.jsxs("select",{value:u,onChange:s=>T(s.target.value),className:"w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"all",children:"All Time"}),e.jsx("option",{value:"today",children:"Today"}),e.jsx("option",{value:"week",children:"Last 7 Days"}),e.jsx("option",{value:"month",children:"Last 30 Days"})]})]}),e.jsx("div",{className:"flex items-end",children:e.jsx("button",{onClick:()=>{D(""),k("all"),T("all")},className:"w-full rounded-lg border border-gray-300 px-4 py-2 transition-colors hover:bg-gray-50",children:"Clear Filters"})})]})}),e.jsxs("div",{className:"rounded-lg border border-gray-200 bg-white shadow-sm",children:[e.jsx("div",{className:"border-b border-gray-200 p-6",children:e.jsxs("h2",{className:"flex items-center text-lg font-semibold text-gray-900",children:[e.jsx(_,{className:"mr-2 h-5 w-5 text-blue-600"}),"Transactions (",f.length,")"]})}),e.jsx("div",{className:"p-6",children:F?e.jsxs("div",{className:"py-8 text-center",children:[e.jsx("div",{className:"mx-auto h-8 w-8 animate-spin rounded-full border-b-2 border-blue-600"}),e.jsx("p",{className:"mt-2 text-gray-500",children:"Loading transactions..."})]}):f.length>0?e.jsx("div",{className:"space-y-4",children:f.map(s=>e.jsx("div",{className:`rounded-lg border p-4 ${y(s)?"border-red-200 bg-red-50":"border-gray-200 bg-gray-50"}`,children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(_,{className:"h-8 w-8 text-gray-400"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:s.book_title||"Unknown Book"}),e.jsxs("p",{className:"text-sm text-gray-600",children:["ISBN: ",s.book_isbn||"N/A"]})]})]}),e.jsxs("div",{className:"mt-2 space-y-1 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"font-medium",children:"Student:"}),e.jsxs("span",{className:"ml-2",children:[s.student_name||"Unknown User"," (",s.member_id||"N/A",")"]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(W,{className:"mr-2 h-4 w-4"}),e.jsxs("span",{children:["Borrowed: ",h(s.borrowed_at)]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(E,{className:"mr-2 h-4 w-4"}),e.jsxs("span",{children:["Due: ",h(s.due_date)]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(X,{className:"mr-2 h-4 w-4"}),e.jsxs("span",{children:["Fine:"," ",s.fine_amount?`$${s.fine_amount.toFixed(2)} ${s.fine_paid?"(Paid)":"(Unpaid)"}`:"$0.00"]})]}),s.extension_status&&e.jsxs("div",{className:"flex items-center",children:[e.jsx(J,{className:"mr-2 h-4 w-4"}),e.jsxs("span",{children:["Extension:"," ",s.extension_status.charAt(0).toUpperCase()+s.extension_status.slice(1),s.requested_days?` (${s.requested_days} days)`:""]})]})]})]}),e.jsxs("div",{className:"ml-4 space-y-2",children:[I(s),!s.returned_at&&e.jsx("button",{onClick:()=>g.visit(`/librarian/returns?transaction=${s.id}`),className:"text-blue-600 hover:text-blue-900 text-sm",children:"Process Return"}),s.extension_status==="pending"&&e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:()=>L(s.extension_id,"approved"),className:"rounded-lg bg-green-600 px-3 py-1 text-sm text-white hover:bg-green-700","aria-label":`Approve extension for transaction ${s.id}`,children:"Approve"}),e.jsx("button",{onClick:()=>L(s.extension_id,"rejected"),className:"rounded-lg bg-red-600 px-3 py-1 text-sm text-white hover:bg-red-700","aria-label":`Reject extension for transaction ${s.id}`,children:"Reject"})]})]})]})},s.id))}):e.jsxs("div",{className:"py-8 text-center text-gray-500",children:[e.jsx(_,{className:"mx-auto mb-3 h-12 w-12 text-gray-300"}),e.jsx("p",{children:"No transactions found matching your criteria."})]})}),N>1&&e.jsxs("div",{className:"flex justify-between items-center p-6 border-t border-gray-200",children:[e.jsx("button",{onClick:()=>$(x-1),disabled:x===1,className:"px-4 py-2 rounded-lg bg-gray-100 text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed",children:"Previous"}),e.jsxs("span",{className:"text-sm text-gray-600",children:["Page ",x," of ",N]}),e.jsx("button",{onClick:()=>$(x+1),disabled:x===N,className:"px-4 py-2 rounded-lg bg-gray-100 text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed",children:"Next"})]})]}),e.jsx("div",{className:"fixed right-4 bottom-4 z-50 space-y-2",children:O.map(s=>e.jsxs("div",{className:`flex max-w-sm items-center space-x-3 rounded-lg border px-4 py-3 shadow-lg ${s.type==="success"?"border-green-200 bg-green-50 text-green-800":"border-red-200 bg-red-50 text-red-800"}`,children:[s.type==="success"&&e.jsx(U,{className:"h-5 w-5 text-green-600"}),s.type==="error"&&e.jsx(A,{className:"h-5 w-5 text-red-600"}),e.jsx("span",{className:"text-sm font-medium",children:s.message}),e.jsx("button",{onClick:()=>P(s.id),className:"text-gray-400 hover:text-gray-600","aria-label":"Close toast notification",children:"Ã—"})]},s.id))})]})]})}export{me as default};
